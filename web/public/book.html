<!--Maybe a visualization of the book portion of this may be interesting.  
Add visualization of the book part of the code here?  
copy from recent.html get book git and visualize.  
use LLM to interact with this text.  
use prompt to use definitions.txt to explain to LLM.  
Interact with book using question/answer and context.  
Load any speech from this time.  

-->

<!DOCTYPE html>
<html>
<head>
    <meta name="viewport"
          content="width=device-width,
                   initial-scale=1.0">

        <!-- update the version number as needed -->
        <script src="config.js"></script>
        <script defer src="/__/firebase/9.19.1/firebase-app-compat.js"></script>
        <!-- include only the Firebase features as you need -->
        <script defer src="/__/firebase/9.19.1/firebase-auth-compat.js"></script>
        <script defer src="/__/firebase/9.19.1/firebase-database-compat.js"></script>
        <script defer src="/__/firebase/9.19.1/firebase-firestore-compat.js"></script>
        <script defer src="/__/firebase/9.19.1/firebase-functions-compat.js"></script>
        <script defer src="/__/firebase/9.19.1/firebase-messaging-compat.js"></script>
        <script defer src="/__/firebase/9.19.1/firebase-storage-compat.js"></script>
        <script defer src="/__/firebase/9.19.1/firebase-analytics-compat.js"></script>
        <script defer src="/__/firebase/9.19.1/firebase-remote-config-compat.js"></script>
        <script defer src="/__/firebase/9.19.1/firebase-performance-compat.js"></script>
        <!-- 
          initialize the SDK after all desired features are loaded, set useEmulator to false
          to avoid connecting the SDK to running emulators.
        -->
        <script defer src="/__/firebase/init.js?useEmulator=true"></script>
    
    
    <title>BOOK Test</title>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<!--    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script> -->
    <script src="https://code.jquery.com/ui/1.14.1/jquery-ui.js"></script>


    <!-- google charts -->    
    <script src='https://apis.google.com/js/platform.js' async defer></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <!-- JZZ Midi lib-->
    <script src="JZZ/JZZ.js"></script>
    <script src="JZZ/JZZ.midi.SMF.js"></script>
    <script src="JZZ/JZZ.synth.Tiny.js"></script>
    <script src="JZZ/JZZ.input.Kbd.js"></script>
    <script src="JZZ/JZZ.gui.Player.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/webmidi@latest/dist/iife/webmidi.iife.js"></script>
    
    <link href="js/datatables/datatables.min.css" rel="stylesheet">
     
    <script src="js/datatables/datatables.min.js"></script>
    <!-- Select2 plugin -->
    <link rel="stylesheet" type="text/css" href="js/datatables/select2.min.css">
    <!-- Select2 plugin -->
    <script src="js/datatables/select2.min.js"></script>

		<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <!-- code editor -->
    <script src="js/codeeditor/codemirror/lib/codemirror.js"></script>
    <link rel="stylesheet" href="js/codeeditor/codemirror/lib/codemirror.css">
    <script src="js/codeeditor/codemirror/mode/javascript/javascript.js"></script>
    <script src="js/codeeditor/codemirror/mode/python/python.js"></script>
    <script src="js/codeeditor/codemirror/mode/shell/shell.js"></script>
    <script src="js/codeeditor/codemirror/mode/htmlmixed/htmlmixed.js"></script>
    <!-- 
    #https://github.com/codemirror/codemirror5/tree/master/mode 
    would be better if this were dynamic 
    -->

    <!-- timeline visjs-->
    <script
      type="text/javascript"
    src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js"
  ></script>
  
  <link href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />
  <link href="timeline.css" rel="stylesheet" type="text/css" />
  
  <script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js'></script>

  
    
    <script src="config.js"></script>
    <script src="globals.js"></script>
    <!-- Tab functions -->
    <script src="js/tabs.js"> </script>

    <script>
//        speech = false;
    </script>
    <script type="module" src="speech.js">      
    </script>
    <script src="keymap.js"></script>
    <script src="languages.js"></script>
    
    <script src="js/drawkeyboard.js"></script>
    
    
    <script src="video.js"></script>
    <script src="midi.js">  </script>
    <script src="chat.js">  </script>

    <script src="pipes.js"></script>
    <script src="recent.js"></script>

    <!-- indexeddb -->
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <!-- local search -->
    <script type="text/javascript" src="js/flexsearch/flexsearch.bundle.min.js"></script>
    <script src="db.js"></script>
    <script src="clock.js"></script>
    <script src="js/ayuda/date.format.js"></script>                


    </head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RXPM3QHNJ3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-RXPM3QHNJ3');
</script>

    <body>
    
    
    <table>
        <tr>
            <td>
                <h1>BOOK</h1>
                <select id="repoSelect"></select><br>

    
            </td>
            <td>
                <div id="usericon" onclick="FUNCS.loadAll(true);"></div>
            </td>
            <td>
                <table>
                    <tr><td>
                <div id="clock" 
                style=	"display: inline-block;
                 font-family: monospace;
                 font-size: 20px;
                 text-align: right;
                 color: lightgray; 
                 border-radius: 10px; 
                 padding: 10px; 
                 background-color: rgba(0, 0, 0, 0.75);">
                </div>
                <div id="secondselapsed" 
                    style=	"display: inline-block;
                    font-family: monospace;
                    font-size: 20px;
                    text-align: right;
                    color: lightgray; 
                    border-radius: 10px; 
                    padding: 10px; 
                    background-color: rgba(0, 0, 0, 0.75);">
                </div>
                <br>
                <p id="load">Firebase SDK Loading&hellip;</p>
                </td>
                    <td valign="top">
                        <label for="currentstate">Current State:</label><br>
                        <div id="currentstate" style="height: 150px;overflow:auto;"></div>    
                    </td>
                </tr>
                </table>
                <script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js'></script>
                 <!-- for slider function -->
                <link href="https://code.jquery.com/ui/1.14.1/themes/ui-lightness/jquery-ui.css" rel="stylesheet">
            
            </td>
            <td>
              <table>
                <tr>
                  <td width="70%">
                    <input type="text" id="current-question" name="current-question" size="50">
                    <button id="ask-current-question" name="ask-current-question">ASK ME</button>
                    <input type="text" id="chat-status" name="chat-status" size="50">
                    <div id="speak">
                        <select id="voiceSelect"></select><br>
                        <!-- status and current command for now just display the string and add any additional midi params-->
                        <label for="mycommand">Building Command:</label><br>
                        <input type="text" id="mycommand" name="mycommand" size="50"><br>
                        <input type="text" id="midicommand" name="midicommand" size="20">
                    
                    </div>
                    <div class="words" contenteditable style="display: none;">
                        <input type="text" id="p" name="p">
                    </div>
    
                  </td>
                  <td width="30%">
                    <img id="thinkingchat" src="images/thinking.gif" height="140px" style="visibility:hidden" />

                  </td>
                </tr>
              </table>
            
            </td>
            <td>
                <!-- Load LLM UI -->
                <p style="display:none">Step 1: Initialize WebLLM and Download Model</p>
                <div class="download-container">
                  <select id="model-selection"></select>
                  <button id="download">Download</button>
                </div>
                <p id="download-status" class="hidden"></p>
                <p style="display:none">Step 2: Chat</p>
                <div class="chat-container" style="display:none">
                  <div id="chat-box" class="chat-box"></div>
                  <div class="chat-input-container">
                    <input type="text" id="user-input" placeholder="Type a message..." />
                    <button id="send" disabled>Send</button>
                  </div>
                </div>
                <div id="chat-stats" class="chat-stats hidden"></div>
                
                <div class="tags-input" style="width:100%;"> 

                    <ul id="tags"></ul> 
                    <input type="text" id="input-tag" size="45"
                        placeholder="Add a tag" /> 
                </div> 
                
                <link href="css/tags.css" rel="stylesheet">
                <link href="css/tabs.css" rel="stylesheet">
                <script src="tags.js"></script>
            
            </td>
            <td>
                <label for="prompt">Custom prompt for LLM:</label><br>
                <textarea id="prompt" name="prompt" rows="5" cols="30"></textarea>        
            </td>
        </tr>

    
    
    </table>


    <div id="vidinfo" valign="top"></div>
    <div id=player></div>
    
    <table>
        <tr>
            <td valign="top">
      <table width="640px">
        <tr>
          <td>
            <canvas id="myvideocanvas" width="640" height="360" style="display: none">Your browser does not support the HTML5 canvas tag.</canvas>
            <video
            id="my-video"
            class="video-js"
            preload="auto"
            controls
            width="640"
            height="360"
            data-setup="{}"
            >
            </video>
        
          </td>
        </tr>
        <tr>
          <td valign="top" width="640px">
            <label for="transcript">Original Transcript:</label>
            <img src="images/edit.png" height="16px" onClick="toggleTranscript();"/>
            <br>
            <textarea id="transcript" style="display:none" rows="10" cols="50"></textarea>
            <div id="transcriptsh" style="height: 90px;overflow:auto; word-break: break-all; word-wrap: break-word;"></div>
            <br>
            <label for="mycomments">My Transcript:</label>
            <img src="images/edit.png" height="16px" onClick="toggleMyComments();"/>
            <br>
            <textarea id="mycomments" style="display:none" rows="10" cols="45"></textarea>
            <div id="mycommentsh" style="height: 190px;overflow:auto;"></div>    
            <div id="submit" valign="top">
              <label for="points">Score:</label>
                <input type="range" id="points" name="points" min="0" max="10" value="1" />
              <button type="button" onclick="saveFeedback()">Update</button>
              <button type="button" onclick="resetFeedback()">Reset Feedback</button>
            </div>
          
        </td>
        </tr>
      </table>
    </td>
    <td valign="top">
        <table>
            <tr>
                <td>
                    <div id="timewindow" width="900px" height="100px"></div>

                    <!--
                    <p>
                        <label for="slider-range-text">Book range:</label>
                        <input type="text" id="slider-range-text" style="border: 0; color: #f6931f; font-weight: bold;" size="100"/>
                      </p>
                       
                      <div id="slider-range"></div>
                
                      <script>
                        $(function() {
            
                            var now = new Date();
                            now.setDate(now.getDate() + 1); //add a day so we get today as well.  
                
                            currdate = now;
                            if (querydate !== null){
                                now = new Date(querydate);
                            }
                            priordate = new Date(now.getDate() - 30);
                
                            $( "#slider-range" ).slider({
                
                            range: true,
                            min: new Date('2020.01.01').getTime() / 1000,
                            max: new Date('2025.01.01').getTime() / 1000,
                            step: 86400,
                            values: [ priordate.getTime() / 1000, currdate.getTime() / 1000 ],
                            slide: function( event, ui ) {
                                str = getgitSelected(ui.values[0], ui.values[1]);
                                str += " " + (new Date(ui.values[ 0 ] *1000).toDateString() ) + " - " + (new Date(ui.values[ 1 ] *1000)).toDateString() ;
                                $( "#slider-range-text" ).val( str );
                            }
                            });
                            $( "#slider-range-text" ).val( (new Date($( "#slider-range" ).slider( "values", 0 )*1000).toDateString()) +
                            " - " + (new Date($( "#slider-range" ).slider( "values", 1 )*1000)).toDateString());
                        });
                
                      </script>
                    -->
                      <table>
                        <tr>
                          <td>
                            <img id="thinkinggit" src="images/thinking.gif" height="200px" style="visibility:hidden"/>
                          </td>
                          <td>
                            <div id="selectionhistory" style="width:250px;height:200px;overflow:auto;">

                            </div>
                          </td>
                          <td>
                            <div id="selectionfilter" style="vertical-align:top;width:250px;height:200px;overflow:auto;">
                              <label for="filterregex">Filter Files:</label><br>
                              <input type="text" id="filterregex" name="filterregex" size="25">
        
                              <label for="prompt">TOPIC Filter prompt for LLM:</label><br>
                              <textarea id="filterprompt" name="filterprompt" rows="4" cols="30"></textarea>
                            </div>
        
                          </td>
                        </tr>
                      </table>
            
                </td>
                <td valign="top">
                  <div id="vistabs" class="tab">
                      <button class="tablinks" onclick="openTab(event, 'gitgraph')">Git Graph</button>
                      <button class="tablinks" onclick="openTab(event, 'wordcanvas')">Word Canvas</button>
                      <button class="tablinks" onclick="openTab(event, 'tempcodewindow')">Code Window</button>
                      <button class="tablinks" onclick="openTab(event, 'reflinks')">REFs</button>
                      <div id="temp_edit_code"> </div>

                  </div>
                    <div id="wordcanvas" class="tabcontent" style="height:100%;width:100%;overflow:hidden;">
    
                    </div>
                    <div id="gitgraph" class="tabcontent" style="display:none;height:100%;width:100%;overflow:hidden;">
                      </div>
                      <div id="reflinks" class="tabcontent" style="display:none;height:800px;width:800px;overflow:scroll;">
                      </div>
                    <div id="tempcodewindow" class="tabcontent" style="display:none;height:100%;width:800px;overflow:scroll;">
                      </div>

                </td>
            </tr>
        </table>
    </td>
    </tr>
    <tr>
        <td>
            <div id="devices">	</div>
            <div id="midi">
                <canvas id="fullpcanvas_labels" width="640" height="24">Your browser does not support the HTML5 canvas tag.</canvas>
                <br>
                <canvas id="fullpcanvas" width="640" height="36">Your browser does not support the HTML5 canvas tag.</canvas>    
             </div>
            
             <div id="out"></div>	
        
        </td>
        <td>
            <table>
                <tr>
                    <td>
                        <div id="recenttopics" style="height:90px;width:900px;overflow:auto;"></div>
                        <!--            <div id="wordcanvas"><svg width="600" height="60"></svg></div> -->
                        <!--            <canvas id="wordcanvas" width="640" height="60" style="display: none">Your browser does not support the HTML5 canvas tag.</canvas>    -->
                        
                    </td>
                    <td>
                        <div id="topicstatus" style="height:90px;width:250px;overflow:auto;"></div>                        
                    </td>
                    <td>
                        <div id="topicdirtree" style="height:90px;width:250px;overflow:auto;"></div>                                              
                    </td>
                </tr>
            </table>

        </td>
    </tr>
    </table>
    
    
    
    
    
    
    <br>
    

    


    <!-- dont need this lookup for now.  hiding the diclabel etc for language.js-->
    <table style="display:none">
    <tr>
        <td>
        <div id="auto" style="width: 100%;height: 200px;overflow:auto;">
        <div id="autodiclabel" class="langlabel">	</div>
        <table id="autodic" class="display" style="width: 100%;">
            <thead>
                <tr>
                    <th>word</th>
                    <th>keys</th>
                    <th>lang</th>
                    <th>meaning</th>
                </tr>
            </thead>
            <tfoot>
                <tr>
                    <th>word</th>
                    <th>keys</th>
                    <th>lang</th>
                    <th>meaning</th>
                </tr>
            </tfoot>
        </table>	
    </td>
    <td>
        <div id="dictionary" style="width: 100%;height: 280px;overflow:auto;">
            <div id="dictablelabel" class="langlabel">	</div>
            <table id="DictionaryTable" class="display" style="width: 100%">
                <thead>
                    <tr>
                        <th>word</th>
                        <th>playall</th>
                        <th>keys</th>
                        <th>user</th>
                        <th>times</th>
                        <th>meaning</th>
                        <th>created</th>
                        <th>lang</th>
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        <th>word</th>
                        <th>playall</th>
                        <th>keys</th>
                        <th>user</th>
                        <th>times</th>
                        <th>meaning</th>
                        <th>created</th>
                        <th>lang</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    
    </td>
    <td>
        <div id="auto" style="width: 100%;height: 200px;overflow:auto;">
            <table id="metadic" class="display" style="width: 100%;">
                <thead>
                    <tr>
                        <th>word</th>
                        <th>keys</th>
                        <th>lang</th>
                        <th>meaning</th>
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        <th>word</th>
                        <th>keys</th>
                        <th>lang</th>
                        <th>meaning</th>
                    </tr>
                </tfoot>
            </table>	
        </div>
    
    </td>
    </tr>
    </table>
    
    

    
    <canvas id="pcanvas" width="110" height="22" style="display: none">Your browser does not support the HTML5 canvas tag.</canvas>    

    <div id="code_chat" style="width: 100%;height: 480px;overflow:auto;">
        <table style="width:100%;height:480px;">
            <tr width="100%;">
              <td width="30%">
                <table>
                  <tr>
                    <td>

                <div id="recent" style="width: 100%;height: 180px;overflow:auto;">
                  <table id="RecentTable" class="display" style="width: 100%">
                    <thead>
                      <tr>
                        <th>id</th>
                        <th>date</th>
                        <th>Title</th>
                        <th>Status</th>
                        <th>Desc</th>
                      </tr>
                    </thead>
                    <tfoot>
                      <tr>
                        <th>id</th>
                        <th>date</th>
                        <th>Title</th>
                        <th>Status</th>
                        <th>Desc</th>
                      </tr>
                    </tfoot>
                  </table>	
              </div>
              </td></tr>
              <tr><td width="100%" align="right">
                <div id="timeline" style="height:300px;"></div>
              </td></tr>

              </table>
            </td>
      
            <td valign="top" width="30%">
                <div class="root-wrapper" style="height:480px;">      
                    <div id="chat_table"  style="overflow:scroll;">
                    <table id="ChatTable">
                    <tr id="templateRow">
                    <td style="display:none">id</td>
                    <td style="display:none">query</td>
                    <td>AI Response</td>
                    <td>Sources</td>
                    </tr>
                    </table>
                    </div>
                </div>
                    </td>
            <td valign="top" width="40%">



                <table width="100%">
                    <tr width="100%">
                        <td halign="left">
                            <label id="for_edit_code" for="edit_code" style="float:left">Code Snippet:</label>
                    </td>
                        <td halign="right">
                        <select id="code_mode" onchange="setGitMode();" style="float:right;">
                            <option value="BOOK">BOOK</option>
                            <option value="GIT" selected>GIT</option>
                        </select>
                    </td>
                </tr>
                </table>
                <div class="root-wrapper">  
                <div class="cm-editor" id="edit_code" style="height:430px">

                </div>
                </div>
            </td>
            </tr>
        </table>    
    </div>
	<div id="gitchart" style="height:200px;"></div>

<!-- word2vec display with graph.  maybe keep, alternative just a simple text representation of this same data.  -->
    <link rel="stylesheet" href="word2vec-demo/css/bootstrap.min.css">
    <!-- <link href="bootstrap.min.css" rel="stylesheet"> -->
    <script type="text/javascript" async="" src="word2vec-demo/scripts/ga.js"></script>
<!--    <script src="word2vec-demo/scripts/jquery-1.11.2.min.js"></script> -->
    <script src="word2vec-demo/scripts/d3.min.js"></script>
  
    <script src="word2vec-demo/scripts/tsne.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.14.1"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.0.0/dist/tf.min.js"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-tsne"></script> -->
    <script src="word2vec-demo/scripts/main.js"></script>
    <!-- main.js zoomTopic maybe should be somewhere else -->
    <script src="timewindow.js"></script>

    <div class="input-group" style="display: none">
        <textarea id="textdata" class="form-control" aria-label="With textarea"
          style="height:100px;">Hey there, Delilah. What's it like in New York city? I'm a thousand miles away. But, girl, tonight you look so pretty. Yes, you do. Times Square can't shine as bright as you. I swear it's true.</textarea>
      </div>
  

      <div class="container" style="display:none">
        <p><b>Specify model and parameters to generate dataset:</b></p>
        <div class="row">
          <div class="col-sm-4">
            <div class="input-group mb-3">
              <div class="input-group-prepend">
                <label class="input-group-text" for="model">Model</label>
              </div>
              <select class="custom-select" id="model">
                <option value="0" disabled>NNLM</option>
                <option value="1" selected="selected">Skip-gram</option>
                <option value="2">CBOW</option>
              </select>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-sm-12">
            <p class="text-secondary" id="modelDetails">This model trains words to predict their context.</p>
          </div>
        </div>
        <div class="row">
          <div class="col-sm-4">
            <div class="input-group mb-3">
              <div class="input-group-prepend">
                <span class="input-group-text" id="inputGroup-sizing-default">Window size</span>
              </div>
              <input type="text" id="windowSize" class="form-control" aria-label="Default"
                aria-describedby="inputGroup-sizing-default" value="3">
            </div>
          </div>
        </div>
        <div class="form-check" style="margin-bottom: 12px">
          <input class="form-check-input" type="checkbox" value="subsample" id="negativeSampling">
          <label class="form-check-label" for="negativeSampling">
            Negative sampling?
          </label>
        </div>
        <div class="row" id="negativeSamplingRatio">
        </div>
        <!-- <div class="row">
          <div class="col-sm-6">
            <div class="form-check" style="margin-bottom: 12px">
              <input class="form-check-input" type="checkbox" value="subsample" id="subsampling" disabled>
              <label class="form-check-label" for="subsampling">
                Subsample frequent words?
              </label>
            </div>
          </div>
        </div> -->
        <button type="button" id="prepareData" class="btn btn-primary">Generate dataset</button>
      </div>

      <div class="container" style="display:none">
        <div class="row">
          <div class="col-sm-6"><b>Tokens:</b></div>
          <div class="col-sm-6"><b>Training examples:</b></div>
        </div>
        <div class="row">
          <div class="col-sm-6" style="overflow-y:auto; height:300px;">
            <table id="tokenTable" class="table table-bordered table-striped mb-0">
              <thead>
                <tr>
                  <th scope="col">No.</th>
                  <th scope="col">Token</th>
                  <th scope="col">Freq</th>
                </tr>
              </thead>
              <tbody>
                <!-- <tr>
                  <th scope="row">1</th>
                  <td>Mark</td>
                  <td>Otto</td>
                </tr> -->
              </tbody>
            </table>
          </div>
          <div class="col-sm-6" style="overflow-y:auto; height:300px;">
    
            <table id="trainingTable" class="table table-bordered table-striped mb-0">
              <thead>
                <tr>
                  <th scope="col">No.</th>
                  <th scope="col" id="col1">Input</th>
                  <th scope="col" id="col2">Output</th>
                </tr>
              </thead>
              <tbody>
                <!-- <tr>
                  <th scope="row">1</th>
                  <td>Mark</td>
                  <td>Otto</td>
                </tr> -->
              </tbody>
            </table>
          </div>
        </div>
        <div class="row">
          <div class="col-sm-6" id="statsVocabSize"></div>
          <div class="col-sm-6" id="statsNumExamples"></div>
        </div>
      </div>

      <div class="container" style="display:none">
        <p><b>Specify parameters to train model:</b></p>
        <div class="row">
          <div class="col-sm-4">
            <div class="input-group mb-3">
              <div class="input-group-prepend">
                <span class="input-group-text" id="inputGroup-sizing-default">Embedding size</span>
              </div>
              <input type="text" id="embeddingSize" class="form-control" aria-label="Default"
                aria-describedby="inputGroup-sizing-default" value="5">
            </div>
          </div>
        </div>
          <div class="row">
        <div class="col-sm-4">
          <div class="input-group mb-3">
            <div class="input-group-prepend">
              <label class="input-group-text" for="inputGroupSelect01">Optimiser</label>
            </div>
            <select class="custom-select" id="inputGroupSelect01">
              <option value="1">SGD</option>
              <option value="2">Momentum</option>
              <option value="3" selected="selected">RMSProp</option>
              <option value="4">Adam</option>
            </select>
          </div>
        </div>
        <div class="col-sm-4">
          <div class="input-group mb-3">
            <div class="input-group-prepend">
              <span class="input-group-text" id="inputGroup-sizing-default">Learning rate</span>
            </div>
            <input type="text" id="learningRate" class="form-control" aria-label="Default"
              aria-describedby="inputGroup-sizing-default" value="0.03">
          </div>
        </div>
        <div class="col-sm-4">
          <div class="input-group mb-3">
            <div class="input-group-prepend">
              <span class="input-group-text" id="inputGroup-sizing-default">Epochs</span>
            </div>
            <input type="text" id="epochs" class="form-control" aria-label="Default"
              aria-describedby="inputGroup-sizing-default" value="10">
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-12">
          <p id="trainDetails">Model will be trained with categorical cross entropy loss function.</p>
        </div>
      </div>
      <button type="button" id="trainModel" class="btn btn-primary" style="width: 150px;" disabled>Train model</button>
    </div>
  
    <div class="container" style="display:none">
      <div class="progress">
        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-warning"
          role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
      </div>
    </div>
  
    <div class="container" style="display:none">
      <p><b>Specify parameters to run t-SNE:</b></p>
      <div class="row">
        <div class="col-sm-4">
          <div class="input-group mb-3">
            <div class="input-group-prepend">
              <span class="input-group-text" id="inputGroup-sizing-default">Learning rate</span>
            </div>
            <input type="text" id="lrtxt" class="form-control" aria-label="Default"
              aria-describedby="inputGroup-sizing-default" value="10">
          </div>
        </div>
        <div class="col-sm-4">
          <div class="input-group mb-3">
            <div class="input-group-prepend">
              <span class="input-group-text" id="inputGroup-sizing-default">Perplexity</span>
            </div>
            <input type="text" id="perptxt" class="form-control" aria-label="Default"
              aria-describedby="inputGroup-sizing-default" value="30">
          </div>
        </div>
      </div>
      <!-- <div class="row"> -->
      <!-- <div class="col-sm-6">
          <form action="https://cs.stanford.edu/people/karpathy/tsnejs/csvdemo.html" id="datatypeform">
            <input type="radio" name="rdata" value="raw" checked=""> Raw NxD data (each row are features)<br>
            <input type="radio" name="rdata" value="dist"> NxN Distance
          </form><br>
        </div> -->
      <!-- <div class="col-sm-4">
          <form action="https://cs.stanford.edu/people/karpathy/tsnejs/csvdemo.html">
          </form>
        </div> -->
      <!-- </div> -->
      <div class="row">
        <div class="col-sm-12">
          <button type="button" id="inbut" class="btn btn-primary" style="width:150px;" disabled>Run t-SNE</button>
          <button type="button" id="stopbut" class="btn btn-danger" style="width:100px;" disabled>Stop</button>
        </div>
      </div>
      <div id="cost" style="text-align:left; font-family: Impact;"></div>
  <!--    <div id="embed"><svg width="600" height="400"></svg></div> -->
  <!--    <div id="embed"><svg width="600" height="60"></svg></div>  -->
    </div>
  
    <div class="container" style="display:none">
      <hr>
      <div class="row col-sm-12">
        <p>References:</p>
        <ul>
          <li><a href="https://arxiv.org/abs/1301.3781">Efficient Estimation of Word Representations in Vector Space</a></li> by Mikolov et. al
          <li><a href="https://arxiv.org/abs/1310.4546">Distributed Representations of Words and Phrases and their Compositionality</a> by Mikolov et. al</li>
          <li><a href="https://www.coursera.org/learn/nlp-sequence-models">Sequence Models in Machine Learning Course by Andrew Ng</a> on Coursera</li>
          <li>Jay Alammar's <a href="https://jalammar.github.io/illustrated-word2vec/">The Illustrated Word2Vec</a></li>
        </ul>
      </div>
      <div class="row col-sm-12">
        <p>Adapted from Andrej Karpathy's <a href="https://cs.stanford.edu/people/karpathy/tsnejs/csvdemo.html">t-SNE CSV
            web demo</a></p>
      </div>
      <div class="row col-sm-12">
        <p>Theme from Bootstrap</p>
      </div>
      <div class="row col-sm-12">
        <p>Maintained by <a href="https://raibosome.github.io">Raimi</a>. See <a href="https://github.com/raibosome/raibosome.github.io/tree/master/word2vec-demo">source code</a>.</p>
      </div>
    </div>
        
      <!-- end word2vec-->
<script>
    player2 = document.getElementById("my-video");
    

    var video = 'WftD98XXHB0';
    var starttimes = [];
    var endtimes = [];
    var st = [];
    var	et = [];
    var myst = [];
    var myet = [];
    
    var users = [];
    var durations = [];
    var maxduration = 0;
    
    var numiterations = 0;
    
    
    var myuid = null;
    var myuser = null;
    var isadmin = false;
    
    var user = null;    
        
    var data;
    //var smf = new JZZ.MIDI.SMF(mozart());
    
    
    function mymidicallback(msg, time, user, lang) {
      console.log(msg);
      triggerCheckCommands();  
      //draw here.  
      //occurs on each noteOn or noteOff...
    }
    
    function updateFeedbackUI(user=0, note=null){
        //occurs on noteOff.  
    }
        
    
    
    document.addEventListener('DOMContentLoaded', function() {
            const loadEl = document.querySelector('#load');
            // // 🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
            // // The Firebase SDK is initialized and available here!
            //
            firebase.auth().onAuthStateChanged(user => { 
              if (user) {
                // User is signed in, see docs for a list of available properties
                // https://firebase.google.com/docs/reference/js/firebase.User
                
                if (user.uid != myuid){
                    addMe(user);
                    myuid = user.uid;
                }
                uid = user.uid;
                    // ...
              } else {
                    // User is signed out
                    // ...
              }
            });
            // firebase.database().ref('/path/to/ref').on('value', snapshot => { });
            // firebase.firestore().doc('/foo/bar').get().then(() => { });
            // firebase.functions().httpsCallable('yourFunction')().then(() => { });
            // firebase.messaging().requestPermission().then(() => { });
            // firebase.storage().ref('/path/to/ref').getDownloadURL().then(() => { });
             firebase.analytics(); // call to activate
            // firebase.analytics().logEvent('tutorial_completed');
            // firebase.performance(); // call to activate
            //
            // // 🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
    
            try {
              let app = firebase.app();
              let features = [
                'auth', 
                'functions',
                'storage', 
                'database',
                'analytics'
              ].filter(feature => typeof app[feature] === 'function');
              loadEl.textContent = `Firebase SDK loaded with ${features.join(', ')}`;
              
            //use this as the base, and then we can write an update to whatever.  
            //we can also use this, if the user is logged in, get that info instead.  
                 var provider = new firebase.auth.GoogleAuthProvider();
    
                firebase.auth()
                  .signInWithPopup(provider)
                  .then((result) => {
                    /** @type {firebase.auth.OAuthCredential} */
                    var credential = result.credential;
    
                    // This gives you a Google Access Token. You can use it to access the Google API.
                    var token = credential.accessToken;
                    // The signed-in user info.
                    user = result.user;
                    //not sure why we need this, but the asynchronous check is not getting kicked off.  
                       if (user) {
                        // User is signed in, see docs for a list of available properties
                        // https://firebase.google.com/docs/reference/js/firebase.User
                        
                            uid = user.uid;
                            
                            FUNCS.loadAll();
                        }
                    // IdP data available in result.additionalUserInfo.profile.
                      // ...
                  }).catch((error) => {
                    // Handle Errors here.
                    var errorCode = error.code;
                    var errorMessage = error.message;
                    // The email of the user's account used.
                    var email = error.email;
                    // The firebase.auth.AuthCredential type that was used.
                    var credential = error.credential;
                    // ...
                  });

    		google.charts.load('current', {'packages':['corechart', 'timeline', 'bar']});
            
            //loadAll();
    
            } catch (e) {
              console.error(e);
              loadEl.textContent = 'Error loading the Firebase SDK, check the console.';
            }
          });
    
    
    
    function getVideoJson(videoid){
        
        video = videoid;
        vref = firebase.database().ref('/misterrubato/' + videoid);
        vref.once('value')
                          .then((snap) => {
                            //.on('value',(snap)=>{
            if (snap.exists()){
                loadVideo();
                seekVideo(0, video, true);
                item = snap.val();
                console.log(snap.val());
                
                //get previous iterations of this.  
                title = snap.val().snippet.description.split('\n')[0];
                author = snap.val().snippet.channelTitle;
                authorurl = "https://www.youtube.com/channel/" + snap.val().snippet.channelId;
                $('#vidinfo').html(title + " (<a href=\"" + authorurl + "\">" + author + "</a>)");
                console.log(title);
    
                //we need to get the iterations here before we do anything else, otherwise the graphic doesnt work.  
                numiterations = getIterations(item.snippet.description, item.snippet.publishedAt, true);
    //			searchPrevious(videoid);
    
    //			getTranscript(item.snippet.description);
                getMedia(item.snippet.description);
    //			getMidi(item.snippet.description);
            }
            else{
                //this is not our video, need to retrieve and allow for commenting.  
                //this can be for comments.  Then we can retrieve comments from the person.  via API
                //misterrubato/watch/xxxx
                //combine this from several people you like.  
                //Need to record the audio though if we do like this.  
                //but this is sustainable then.  This is a web server per person.  
                //when you are following someone, the algorithm would overlay that audio on top of 
                //whatever you are watching based on your settings.  
                //we need a master DB though probably, otherwise you have too much unnecessary traffic.  
                //add this description to our DB using timestep.  
                //item.snippet.description
                watch = true;
                loadVideo();
                console.log(videoid + " Not in DB.  Retrieving from Youtube API");
                vref = firebase.database().ref('/watch/' + videoid);
                vref.on('value',(snap)=>{
                    if (snap.exists()){
                    //retrieve previous comments etc.  
                    }
                    else{
                    //		obj = {"comments": mycomments, "sentiment": grade };
                    //uRef.set(obj);
                    }
                });
                    tempurl = 'https://www.youtube.com/watch?v=' + videoid;
    
                    //https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=R4LoM208_Ow
                    $.getJSON('https://www.youtube.com/oembed?url=' + tempurl, function (data) {
                        console.log(data.title);
                        title = data.title;
                        console.log(data.author_name);
                        author = data.author_name;
                        console.log(data.author_url);
                        authorurl = data.author_url;
                        console.log(data.thumbnail_url);
                        $('#vidinfo').html(title + " (<a href=\"" + authorurl + "\">" + author + "</a>)");
                    });
                    //input details about this video
    
            }
    
        });
    
    /*	
     $.getJSON('https://www.googleapis.com/youtube/v3/videos?id=' + videoid + '&key=' + webkey + '&part=snippet&callback=?',function(data){
        if (typeof(data.items[0]) != "undefined") {
    //	    videojson = data.items[0];
            console.log('video exists ' + data.items[0].snippet.title);
            $('#iterations').val(data.items[0].snippet.description);
            createNotesArray();
            //get previous iterations of this.  
            title = notesarray[0];
            searchPrevious(videoid);
            getTranscript(data.items[0].snippet.description);
            getMidi(data.items[0].snippet.description);
           } else {
            console.log('video not exists');
         }   
        });
    */
    
    
    }
    
    
    function getTime(comment){
        const regExp = /\(([^)]+)\)/g;
        const matches = [...comment.matchAll(regExp)].flat();
    //    console.log(matches);
        if (matches.length > 0){
            return getSecsFromTime(matches[1]);
        }
        else{
            return 0;
        }
    }
    
    
    function getIterations(desc, vidtime, isme=false){
        st = [];
        et = [];
        s = 0;
    
        if (desc ==""){
            //one iteration length of video.  
            //this is for watch.  
            e = player.getDuration();
            st.push(1);
            et.push(e);
            maxduration = e-1;
            numiterations = 1;
            myst.push(st[0]);
            myet.push(et[0]);
        }
        else{
            for (i=1; i< 20; i++){
                s = -1;
                e = -1;
                fnd = "TRIAL#" + i;
                let ts = desc.indexOf(fnd);
                te = desc.indexOf(")", ts);
                if (ts > -1)
                    s = getSecsFromTime(desc.substring(ts+(fnd.length)+2, te));
                    
                fnd = "END#" + i;
                ts = desc.indexOf(fnd);
                te = desc.indexOf(")", ts);
                if (ts > -1)
                    e = getSecsFromTime(desc.substring(ts+(fnd.length)+2, te));
                if (s > -1 && e > -1 && e > s){
                    st.push(s);
                    et.push(e);
                }
            }
            console.log(st);
            console.log(et);
            //arrays of all iterations
            mydate = new Date(vidtime);
    //		if (!isme){
                for (i=0; i< st.length; i++){
                    if (et[i] !==null){
                        tempdate = mydate;
                        tempdate.setSeconds(tempdate.getSeconds()+st[i]);
                        starttimes.push(tempdate);
                        durations.push([tempdate, et[i]-st[i]]);
                        if (isme){
                            myst.push(st[i]);
                            myet.push(et[i]);
                            if (et[i]-st[i] > maxduration){
                                maxduration = et[i]-st[i];
                                
                            }
                        }
                        tempdate.setSeconds(tempdate.getSeconds()+(et[i]-st[i]));
                        endtimes.push(tempdate);
                    }
                }
            }
            //from here generate some sort of graphic.  
    //	}
        return st.length;
    }
    
    
    function addMe(user){
        myuser = user;
        uid = user.uid;
        displayname = user.displayName;
    //	email = user.email;
    //	phone = user.phoneNumber;
        pic = user.photoURL;
    
        users.push({"uid": uid, "pic": pic, "name": displayname}); //lookup for array location -> uid
    
        console.log(displayname + " " + pic);
    
        //add user icon
        document.getElementById("usericon").innerHTML = "";
        var elem = document.createElement("img");
          elem.setAttribute("src", user.photoURL);
          elem.setAttribute("alt", user.displayName);
          elem.setAttribute("height", "64");
          elem.setAttribute("width", "64");
          document.getElementById("usericon").appendChild(elem);	//add to DB.  
    
        //do we need this, this doesnt work with Watch:
        /*
        uRef2 = firebase.database().ref('/misterrubato/' + video + '/uid');
        firebase.database().ref('/misterrubato/' + video + '/uid').once('value')
                          .then((snapshot) => {
                            if (snapshot.exists()) {
    
                            } else {
                                
                                obj = {"uid": uid};	
                                uRef2.set(obj);
                            }
                        });
        */
    
        uRef = firebase.database().ref('/users/' + uid);
        firebase.database().ref('/users/' + uid).once('value')
                          .then((snapshot) => {
                            now = new Date();
                            if (snapshot.exists() && typeof(snapshot.val().numlogins) !="undefined") {
                                num = snapshot.val().numlogins + 1;
                                ll = now.toISOString().substring(0, 10).replaceAll('-','');
                                uRef.update({"numlogins": num, "lastlogin": ll});
    
                            } else {
                                
                                obj = {"name": displayname, "pic": pic, "firstlogin": now.toISOString().substring(0, 10).replaceAll('-',''), "lastlogin": now.toISOString().substring(0, 10).replaceAll('-',''), "numlogins": 1};	
                                uRef.set(obj);
                            }
                        });
        
    }
    
    function loadComplete(user){
                //not sure why we need this, but the asynchronous check is not getting kicked off.  
                if (user) {
                
                    uid = user.uid;
                    addMe(user);

                }
    
    
    }
    
</script>

<script>
  FUNCS = {};
</script>

<script type="module">
        import * as SPEECH from "/speech.js"
  /*
        import loadSpeech from "/speech.js";
        import addComment from "/speech.js";
        import helpme from "/speech.js";
        import getVoice from "/speech.js";
        import checkCommands from "/speech.js";
  */
    export default function loadAll(reload = false){
        gitSignin();

        SPEECH.loadSpeech();
        $("#ask-current-question").click(function(){
          lastspokenword="comment";  //alternative to using midi.          
          MyChat($("#current-question").val());
        });
    
        setupMidi();
        reinitLanguages();
        loadUserConfig();
        loadDictionaries(0);

//        pipeListen();

        //firebase.auth.Auth.Persistence.LOCAL 'local'
        firebase.auth().setPersistence('local').then(() => {
    //firebase.auth().setPersistence('session').then(() => {
        if (reload){
            user = null;
        }
        else{
            user = firebase.auth().currentUser;
        }
        if (!user || user == null){
            var provider = new firebase.auth.GoogleAuthProvider();
            firebase.auth().signInWithPopup(provider)
            .then((result) => {
                /** @type {firebase.auth.OAuthCredential} */
                var credential = result.credential;
    
                // This gives you a Google Access Token. You can use it to access the Google API.
                var token = credential.accessToken;
                // The signed-in user info.
                user = result.user;
                this.currentUser = user;
                user.getIdTokenResult(true).then((result) => {
                    isadmin = result.claims.admin;
                    if (isadmin){
                        console.log("ADMIN USER");
                    }
                    else{
                        console.log("NOT ADMIN USER - send website address to request admin access.  ");
                    }
                    //we can check this prior to updating.  
                });				
                console.log(user);
                
                //if not set, set the DB uid.  
                loadComplete(user);			
            });
         }
         else{
            loadComplete(user);
         }
    
            // IdP data available in result.additionalUserInfo.profile.
            // ...
        }).catch((error) => {
            // Handle Errors here.
            var errorCode = error.code;
            var errorMessage = error.message;
            // The email of the user's account used.
            console.log(errorMessage);
            var email = error.email;
            // The firebase.auth.AuthCredential type that was used.
            var credential = error.credential;
            // ...
        });
    
        getVideoJson(video);
        //get book for analysis via LLM.  
        populateGitRepos(getState('selectedgitindex')); //select repo to analyze.  
        selectGitRepo(getState('selectedgitindex')); //this loads the repo and gitstruct.  

        loadAllRecent(25);


//        setTimeout(getGitCommits("2024-12-12"), 5000);
//        getGitCommits("2024-12-12");  //need to pass login token to do this.  Too many requests.  

//        getGitContents('web/public/book.html');
        setTimeout(function(){ document.getElementById("download").click(); }, 2000);
                //from test.js set context_window_size to sliding.  
    }
    

    FUNCS.loadAll = loadAll;
    FUNCS.SPEECH = SPEECH;

    </script>




<script type="text/javascript">
    LLM = {};    
</script>


<script type="module">
    import {onMessageSend} from '/test/web-llm/test.js';
    LLM.sendToLLM = onMessageSend;
//    LLM.stopllm = stopllm;
    //window.sendToLLM = onMessageSend;
</script>

<script type="module">
//    import { Octokit, App } from "https://esm.sh/octokit";
//    LLM.Octokit = Octokit;
//    LLM.App = App;
</script>



<script src="git.js"></script>

<script>

var mycontext = "";
var files = [];



function setTranscript(transcript){
	$('#transcriptsh').html(makeTimeLinks(transcript));
	//right now this is not refreshed on page load.  
	//this ends up being the original transcript for some reason.  
	//not sure if we want this or not.  Here we dont keep history about the original transcript.  
	//is this important?  
	var tempDiv = $('#transcript');
	if (isadmin){
		tempDiv.readOnly = false;
	}
	else{
		tempDiv.readOnly = true;
		//we get the updated transcript, but cant edit further.  This removes confusion about if you can edit.  
	}
	tempDiv.val(transcript);
	createTranscriptArray();
}

function toggleTranscript(){
	if ($('#transcript').is(':visible')){
		setTranscript($('#transcript').val());
		$('#transcript').hide();
		$('#transcriptsh').show();
	}
	else{
		$('#transcript').show();
		$('#transcriptsh').hide();
	}
}


function toggleMyComments(){
	if ($('#mycomments').is(':visible')){
		createNotesArray(); //update values of the data.  
		$('#mycomments').hide();
		$('#mycommentsh').show();
	}
	else{
		$('#mycomments').show();
		$('#mycommentsh').hide();
	}
}
function loadTranscript(snapshot){
	console.log(snapshot.val().transcript);
	if (snapshot.val().transcript !==null){
		//not sure if we want this or not.  Here we dont keep history about the original transcript.  
		//is this important?  
		originaltranscript = snapshot.val().transcript;
		setTranscript(snapshot.val().transcript);
	}
}


function updateNotes(){
    var allnotes = "";
	for (i=0; i<notesarray.length; i++){
	    allnotes += notesarray[i] + "\n";
	}
    $('#mycomments').val(allnotes);
	//add clickable link inside here instead.  
	$('#mycommentsh').html(makeTimeLinks(allnotes));

  $('#mycommentsh').animate({
          scrollTop: $('#mycommentsh')[0].scrollTop+50}, "slow"
        );
  $('#mycomments').animate({
          scrollTop: $('#mycomments')[0].scrollTop+50}, "slow"
        );

	
}

function createTranscriptArray(){
//also update the new DIV with links.  
	alltranscript = $('#transcript').val();
	transcriptarray = [];
	const lines = alltranscript.split("\n");
	for (i = 0; i< lines.length; i++){
	    transcriptarray[i] = lines[i];
	}
	console.log(transcriptarray);

}

function createNotesArray(){
//also update the new DIV with links.  
	allnotes = $('#mycomments').val();
	notesarray = [];
    const lines = allnotes.split("\n");
	for (i = 0; i< lines.length; i++){
	    notesarray[i] = lines[i];
	}
	console.log(notesarray);
	//set title
    updateNotes();
}


function ChatLocalUpdate(answer){
    lastread = answer.length + lastread; //usually lastread = 0
    ssu = new SpeechSynthesisUtterance(answer);
    ssu.voice = FUNCS.SPEECH.getVoice();
    ssu.rate = myrate;
    ssu.pitch = mypitch;
    window.speechSynthesis.cancel();
    reading = true;
    ssu.onend = function (event) {
        console.log(event.timeStamp);
        reading = false;
    };

    window.speechSynthesis.speak(ssu);

}

function ChatLocalDone(answer){
    //called from //test/web-llm/test.js

    var img = document.getElementById('thinkingchat');
    img.style.visibility = "hidden";

    tospeak = addChatRow(lastquery, answer, []);
    tospeak = tospeak.slice(lastread);
    lastread = 0;
    ssu = new SpeechSynthesisUtterance(tospeak);

    ssu.voice = FUNCS.SPEECH.getVoice();
    ssu.rate = myrate;
    ssu.pitch = mypitch;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(ssu);
    var myDiv = document.getElementById('code_chat');
    $('#code_chat').animate({
          scrollTop: 0}, "slow"
        );

    console.log('query ' +  lastquery);
//                    addComment(data.answer, helpme())
    console.log('response  ' + answer);
    chathistory[chathistory.length-1].answer = answer; //set answer to previous query.  

    //dont actually want this in the comment.  
//    FUNCS.SPEECH.addComment("==" + answer, FUNCS.SPEECH.helpme());
    //add to message context.  
    //messages.push({ role: "assistant", content: answer });
    //further queries dont need to contain all the same info.  

    
}




function GetRecentSelections(shortformat=false){
    //use last few of selectionhistory in order to create more context.  
    //make this the last few selected documents.  
    ctx = "";
    for (si=0; si<selectionhistory.length; si++){
        //really we want recent commits here, and not full source.  
        //and in order.  ...
        if (shortformat){
          if (si > 0){  //dont want first entry always loading definitions.  
            ctx += "**" + selectionhistory[si] + "\n";
          }
        }
        else{

          ctx += "**" + selectionhistory[si] + "\n" + getGitContents(selectionhistory[si], false) + "\n";

          exists = gitcommits.find(x => x.filename === selectionhistory[si]);
          if (exists){
            ctx += "**" + selectionhistory[si] + "\n" + exists.patch + "\n";
          }

          //book last?  not sure the preferred order.  
          if (selectionhistory[si] in gitstruct["bytopic"]){
            ctx += "**" + selectionhistory[si] + "\n";
            for (let gi=0; gi<gitstruct["bytopic"][ selectionhistory[si] ].length; gi++){
                ctx += "**" + gitstruct["bytopic"][ selectionhistory[si] ][gi].d + "\n" + gitstruct["bytopic"][ selectionhistory[si] ][gi].content + "\n";
            }
            
          }

      }

    }
    return ctx;
}

function GetRecentChat(){
    ctx = "";
    for (ci=0; ci<chatmessages.lengh; ci++){
        a = chatmessages[ci].answer.replaceAll("**", "__");
        a = a.replaceAll("@@", "__");
        a = a.replaceAll("==", "--");
        ctx += "@@" + chatmessages[ci].query + "\n\n==" + a + "\n\n";
    }
    return ctx;
}

function ChatBuildContext(context){
    recentcontext = GetRecentSelections();
    recentchatmessages = GetRecentChat();
    lastquery = context;
    $('#current-question').val(lastquery);
    mycontext = "";
    definitions = "";
    files = [];
    for (gi = gitbook.length-1; gi>-1; gi--){
        fn = getFileName(gitbook[gi].url);
        if (fn == "definitions" || mycontext.length + gitbook[gi].content.length < MAX_LOCAL_QUERY_LENGTH){

            files.push(gitbook[gi].url);
            if (fn == "definitions"){
                definitions = "**" + fn + "\n" + gitbook[gi].content + "\n\n";
            }
            else{
                mycontext = "**" + fn + "\n" + gitbook[gi].content + "\n\n" + mycontext;
            }
        }
        
    }
    mycontext = definitions + mycontext + recentcontext;
    //will need to add actual source files as well here to context.  

    //cant have @@ or == in this content.  
    mycontext = mycontext.replaceAll("@@", "__");
    mycontext = mycontext.replaceAll("==", "--");
    
    console.log(files);
    mycontext = mycontext + recentchatmessages + "\n@@" + lastquery;

    //add all data from previous question/answers.  

    
}

function ChatLocal(transcript){
    gitbook.sort((a, b) => a.name - b.name);
    if ($('#prompt').val() == ""){
        $('#prompt').val(localprompt);
    }
    else{
        localprompt = $('#prompt').val();
    }
    ChatBuildContext(transcript);

    addChatHistory(lastquery, mycontext, files);
    document.getElementById("user-input").value = mycontext;
    //reset chat response.  
    $("#chat-status").val("");

    console.log(mycontext);
    (async() => {
      var img = document.getElementById('thinkingchat');
    img.style.visibility = "visible";

  console.log('1')
  await LLM.sendToLLM(); //onMessageSend();//sendToLLM();   //test/web-llm/test.js
  console.log('2')
})()

    
}

			function MyChat(transcript) {
				mychat = transcript; //$('#p').val();
				if (mychat.toUpperCase().startsWith("STOP")){
					window.speechSynthesis.cancel();
                    stopllm = true;
					return;
				}
                if (lastspokenword !="comment"){ //if we have comment in our command.  
                    //only chat if we have pedal pressed.  
                    return;
                }
                else{
                    lastspokenword = ""; //for now just reset so not called again.  
                }
                //use local if available.  check for GPU for local LLM usage as well.  
                if (ChatLocal !== undefined){
                    ChatLocal(mychat);
                    FUNCS.SPEECH.addComment("@@" + transcript, FUNCS.SPEECH.helpme());
                    return;
                }
				//get prompt
				myprompt = $('#prompt').val();
//                addComment(mychat, helpme());
				//this should be linked to the video being watched loosely perhaps.  
				$.getJSON(chatdomain + ':8000/api/?query=' + encodeURIComponent(mychat) + '&prompt=' + encodeURIComponent(myprompt),function(data){
                  
				  if (typeof(data.answer) != "undefined") {
					addChatRow(data.query, data.answer, data.sources);
					ssu = new SpeechSynthesisUtterance(data.answer);
					ssu.rate = myrate;
					ssu.pitch = mypitch;
                    window.speechSynthesis.cancel();
					window.speechSynthesis.speak(ssu);

                    console.log('query ' +  data.query);
//                    addComment(data.answer, helpme())
					console.log('response  ' + data.answer);
					console.log('sources  ' + data.sources);
					for (j=0; j<data.sources.length; j++) {
						console.log('content ' + data.sources[j].content );
                        console.log('metadata ' + data.sources[j].metadata);
                        vid = getVidFromMetadata(data.sources[j].metadata);
//                        addSource(data.sources[j]);
                        
					}
				   } 
				   else {
					console.log('chat failed');
                    console.log(data);
				   }   
				});
			
			}

      

</script>
</body>
</html>
    