
<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content=
		"width=device-width, initial-scale=1.0">
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js'></script>
<script src="https://cdn.jsdelivr.net/npm/webmidi@latest/dist/iife/webmidi.iife.js"></script>
<link href="css/app-dictaphone.css" rel="stylesheet" type="text/css">
	<title>Speech to Text</title>
	<style>
		table {
		  border-collapse: collapse;
		  width: 100%;
		}
		
		tr {
		  border-bottom: 1px solid #ddd;
		}
		</style>	
</head>

    <!-- update the version number as needed -->
	<script src="config.js"></script>
    <script defer src="/__/firebase/9.19.1/firebase-app-compat.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/9.19.1/firebase-auth-compat.js"></script>
    <script defer src="/__/firebase/9.19.1/firebase-database-compat.js"></script>
    <script defer src="/__/firebase/9.19.1/firebase-firestore-compat.js"></script>
    <script defer src="/__/firebase/9.19.1/firebase-functions-compat.js"></script>
    <script defer src="/__/firebase/9.19.1/firebase-messaging-compat.js"></script>
    <script defer src="/__/firebase/9.19.1/firebase-storage-compat.js"></script>
    <script defer src="/__/firebase/9.19.1/firebase-analytics-compat.js"></script>
    <script defer src="/__/firebase/9.19.1/firebase-remote-config-compat.js"></script>
    <script defer src="/__/firebase/9.19.1/firebase-performance-compat.js"></script>
    <!-- 
      initialize the SDK after all desired features are loaded, set useEmulator to false
      to avoid connecting the SDK to running emulators.
    -->
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>


<body>
    <div class="words" contenteditable>
		<input type="text" id="p" name="p">
   </div>

	<button type="button" onclick="Chat()">Update</button>
<table>
		<tr valign="top">
		<td>
		
			  <div id="player" valign="top"></div>
	  
		  <div id="submit" valign="top">
			  <input type="range" id="points" name="points" min="0" max="10" value="1" />
			  <button type="button" onclick="rateResponse()">Update</button>
		  </div>
	   <div id="midi"></div>
	  <!--    <button type="button" onclick="saveMidiFeedback();">Save Midi Feedback</button> -->
		  <div id="out"></div>	
	  
	  </td>
	  
	  <td>
	  
		<div id="clock" 
			 style=	"display: inline-block;
			  font-family: monospace;
			  font-size: 30px;
			  text-align: right;
			  color: lightgray; 
			  border-radius: 10px; 
			  padding: 10px; 
			  background-color: rgba(0, 0, 0, 0.75);">
		</div>
		<div id="secondselapsed" 
			 style=	"display: inline-block;
			  font-family: monospace;
			  font-size: 30px;
			  text-align: right;
			  color: lightgray; 
			  border-radius: 10px; 
			  padding: 10px; 
			  background-color: rgba(0, 0, 0, 0.75);">
		</div>
		
		<br>
		  <p id="load">Firebase SDK Loading&hellip;</p>
		  <div id="iterationsh" style="height: 390px;overflow:auto;"></div>
	  <!--    <textarea id="iterations" rows="40" cols="40"></textarea> -->
	  </td><td>
		<div id="mycommentsh"></div>
		<textarea id="mycomments" rows="20" cols="40"></textarea>
	
		  <div id="mychatsh"></div>
		  <textarea hidden id="mychat" rows="20" cols="10"></textarea>
	  </td><td>
		<div id="transcriptsh" style="height: 390px;overflow:auto;"></div>
        <div id="sourcessh"></div>
        <textarea hidden id="sources" rows="20" cols="10"></textarea>
	  </td>
	  </tr>
	  </table>
	  
	  <table id="ChatTable">
		<tr id="templateRow">
		<td>id</td>
		<td>query</td>
		<td>AI Response</td>
		<td width="50%">Sources</td>
		</tr>
		</table>

      <script type="text/javascript" src="clock.js"></script>
      <script type="text/javascript" src="midi.js"></script>
	  <script type="text/javascript" src="db.js"></script>
	  <script src="JZZ/JZZ.js"></script>
	  <script src="JZZ/JZZ.midi.SMF.js"></script>
	  

    <script>

        var video = 'T7aCHEAGCsU';
        var videojson = null;
        var channelId = 'UC4dK3RpqBq2JpIkRmQn6HOA'; //@misterrubato doesnt work in URL, probably need to escape the @, but who cares.  
        var title = '';
        var seek = -1;
        var sources = [];
		var uid = null;
		var delay = 0;
		var ChatID = 0;


		document.addEventListener('DOMContentLoaded', function() {
        const loadEl = document.querySelector('#load');
        // // ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥
        // // The Firebase SDK is initialized and available here!
        //
         firebase.auth().onAuthStateChanged(user => { 
		   if (user) {
			// User is signed in, see docs for a list of available properties
			// https://firebase.google.com/docs/reference/js/firebase.User
			
			uid = user.uid;
				// ...
			  } else {
				// User is signed out
				// ...
			  }
			});
        // // ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥

        try {
          let app = firebase.app();
          let features = [
            'auth', 
            'functions',
            'storage', 
			'database',
          ].filter(feature => typeof app[feature] === 'function');
          loadEl.textContent = `Firebase SDK loaded with ${features.join(', ')}`;
		  
		//use this as the base, and then we can write an update to whatever.  
		//we can also use this, if the user is logged in, get that info instead.  
			 var provider = new firebase.auth.GoogleAuthProvider();

			firebase.auth()
			  .signInWithPopup(provider)
			  .then((result) => {
				/** @type {firebase.auth.OAuthCredential} */
				var credential = result.credential;

				// This gives you a Google Access Token. You can use it to access the Google API.
				var token = credential.accessToken;
				// The signed-in user info.
				var user = result.user;
				//not sure why we need this, but the asynchronous check is not getting kicked off.  
				   if (user) {
					// User is signed in, see docs for a list of available properties
					// https://firebase.google.com/docs/reference/js/firebase.User
					
					uid = user.uid;
					addUser(user);
					
					}
				// IdP data available in result.additionalUserInfo.profile.
				  // ...
			  }).catch((error) => {
				// Handle Errors here.
				var errorCode = error.code;
				var errorMessage = error.message;
				// The email of the user's account used.
				var email = error.email;
				// The firebase.auth.AuthCredential type that was used.
				var credential = error.credential;
				// ...
			  });

			//google.charts.load('current', {'packages':['corechart', 'timeline']});
        			
        } catch (e) {
          console.error(e);
          loadEl.textContent = 'Error loading the Firebase SDK, check the console.';
        }
      });

	  		function loadVideo(secs, v){
				if (v !="" && v != video){
					video = v;
					player.loadVideoById(video);
					//load data and transcript from this video.  
					if (uid != null){
	
						ref = firebase.database().ref('/misterrubato/' + video);
						ref.on('value',(snap)=>{
							if (snap.exists()){
								item = snap.val();
								console.log(snap.val());
								$('#iterationsh').html(makeTimeLinks(snap.val().snippet.description))
								
								//get previous iterations of this.  Probably dont need here.  
								title = snap.val().snippet.description.split('\n')[0];
								console.log(title);
							}
						});

						//should just use this object.  

						//get the data from the database.  
						firebase.database().ref('/misterrubato/' + video + '/comments/' + uid).once('value')
						.then((snapshot) => {
							if (snapshot.exists()) {
								loadPreviousComments(snapshot);
							}
							
						});

						firebase.database().ref('/misterrubato/' + video + '/transcript').once('value')
								.then((snapshot) => {
									if (snapshot.exists()){
										loadTranscript(snapshot);
									}
									else{
										console.log('No transcript');									
										//should never occur
									}
								});
					}
					//ontimer.. wait for video to load.  
					setTimeout(() => {
						if (player.getPlayerState() == 1) {
							player.seekTo(secs);
						}
						else {
							ytSeconds = secs;
							player.playVideo();
						}
					}, 2000);
				}
			}

			function loadTranscript(snapshot){
				console.log(snapshot.val().transcript);
				if (snapshot.val().transcript !==null){
					$('#transcriptsh').html(makeTimeLinks(snapshot.val().transcript));
				}
			}

			function loadPreviousComments(snapshot){
				console.log(snapshot.val().comments);
				if (snapshot.val().comments !==null){
					$('#mycomments').val(snapshot.val().comments);
					$('#mycommentsh').html(makeTimeLinks(snapshot.val().comments));
				}
				else{
					$('#mycomments').val('');
					$('#mycommentsh').html('');

				}
				
				if (snapshot.val().sentiment !==null){
					$('#points').val(snapshot.val().sentiment);
				}
				//load midi.  
				//this causing some problems for sure.  
				//need to check again in analyze as well.  
				midifeedback = snapshot.val().midi;
				try{
					loadMidiFeedback(midifeedback);
				}	
				catch(err){
					console.log(err);
				}

				
				console.log("MIDI:" + midifeedback);
			//							document.getElementById('out').innerHTML = 'New file: <a download=my.mid href=' + midifeedback + '>DOWNLOAD</a> <embed src=' + midifeedback + ' autostart=false>';

			}

            function makeTimeLinks(desc, vid){
                desc = desc.replaceAll("\n", "<br>");
            //    desc = desc.replace(")", ")<br>");
                const regExp = /\(([^)]+)\)/g;
                regExp2 = /\d+\:\d\d?/g;
                const matches = [...desc.matchAll(regExp2)].flat();
                for (var i=0; i<matches.length; i++){
                    secs = getSecsFromTime(matches[i]);
                    if (secs > 0){
                        desc = desc.replace(matches[i], '<a href="#" onclick="loadVideo(' + secs + ', &quot;' + vid + '&quot;);">' + matches[i] + '</a>');
                    }

                }
            //    console.log(matches);
                return desc;
            }


			function getSecsFromTime(time){
				minsec = time.split(":");
				if (minsec == time)
					return 0;
				console.log(+parseInt(minsec[0])*60 + +parseInt(minsec[1]));
				return +parseInt(minsec[0])*60 + +parseInt(minsec[1]);
				
			}
			
			function updateNotes(){
				var allnotes = "";
                var allnoteshtml = "";
				for (var i=0; i<notesarray.length; i++){
					allnotes += notesarray[i] + "\n";
                    allnoteshtml += makeTimeLinks(notesarray[i]) + "<br>";
				}
				$('#mychat').val(allnotes);
				$('#mychatsh').html(allnoteshtml);
				
			}
			
			function getSourceHTML(sources, rowid){
                allsources = '<table><tr>';
				for (i=0; i<sources.length; i++){
					vid = getVidFromMetadata(sources[i].metadata);
					//get vid details
					allsources += '<td width="25%">';
					if ((i+rowid)%2==0){
						allsources += '<font color="red">';
					}
					allsources += makeTimeLinks(sources[i].content, vid);
					if ((i+rowid)%2==0){
						allsources += '</font>';
					}
					allsources += '</td>';
				}
				allsources += '</tr></table>';
				return allsources;

			}
			function updateSources(){
                allsources = '';
				for (i=0; i<sources.length; i++){
					vid = getVidFromMetadata(sources[i].metadata);
					//get vid details
					allsources += '<br><br>';
					if (i%2==0){
						allsources += '<font color="red">';
					}
					allsources += makeTimeLinks(sources[i].content, vid);
					if (i%2==0){
						allsources += '</font>';
					}
				}
				return allsources;
				
			}

            function createNotesArray(){
			//also update the new DIV with links.  
				allnotes = $('#mychat').val();
				notesarray = [];
				const lines = allnotes.split("\n");
				for (i = 0; i< lines.length; i++){
					notesarray[i] = lines[i];
				}
				console.log(notesarray);
				//set title
				updateNotes();
			}
			

            function getTime(comment){
				const regExp = /\(([^)]+)\)/g;
				const matches = [...comment.matchAll(regExp)].flat();
			//    console.log(matches);
				if (matches.length > 0){
					return getSecsFromTime(matches[1]);
				}
				else{
					return 0;
				}
			}
			
			
			function addSource(source){
                sources.splice(0, 0, source);
                s = updateSources();
				$('#sourcessh').html(s);
			}

            function getVidFromMetadata(m){
                vid = m.substring(m.lastIndexOf("/")+1, m.lastIndexOf("."));
                return vid;
            }

            //openssl req -x509 -newkey rsa:4096 -nodes -out cert.pem -keyout key.pem -days 365
            //app.run(ssl_context=('cert.pem', 'key.pem'))

			function addChatRow(query, answer, source) {
				answer = answer.replaceAll("\n", "<br>");
				var t = document.getElementById("ChatTable");
				var rows = t.getElementsByTagName("tr");
				var r = rows[0];
				ChatID += 1;
				t.insertRow(1);
				r = rows[1]; //always insert after the header row any new info.  
				r.style.border = "1px solid #000"
				// the same as
				r.style.borderWidth = "1px";
				r.style.borderColor = "#000";
				r.style.borderStyle = "solid";
				for (i=0; i<4; i++){
					r.insertCell(i);
				}
				r.cells[0].innerHTML = ChatID;
				r.cells[1].innerHTML = query;
				r.cells[2].innerHTML = answer;
				r.cells[3].innerHTML = getSourceHTML(source, ChatID);
			}

			function Chat(transcript) {
				mychat = transcript; //$('#p').val();
//                addComment(mychat, helpme());
				//this should be linked to the video being watched loosely perhaps.  
				$.getJSON(chatdomain + ':8000/api/?query=' + encodeURIComponent(mychat),function(data){
                  
				  if (typeof(data.answer) != "undefined") {
					addChatRow(data.query, data.answer, data.sources);
                    console.log('query ' +  data.query);
//                    addComment(data.answer, helpme())
					console.log('response  ' + data.answer);
					console.log('sources  ' + data.sources);
					for (j=0; j<data.sources.length; j++) {
						console.log('content ' + data.sources[j].content );
                        console.log('metadata ' + data.sources[j].metadata);
                        vid = getVidFromMetadata(data.sources[j].metadata);
//                        addSource(data.sources[j]);
                        
					}
				   } 
				   else {
					console.log('chat failed');
                    console.log(data);
				   }   
				});
			
			}
			

			function rateResponse(){

			}
			</script>



<script type="text/javascript" src="speech.js"></script>

            <script>
                // 2. This code loads the IFrame Player API code asynchronously.
                var tag = document.createElement('script');
          
                tag.src = "https://www.youtube.com/iframe_api";
                var firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
          
                // 3. This function creates an <iframe> (and YouTube player)
                //    after the API code downloads.
                function onYouTubeIframeAPIReady() {
                  player = new YT.Player('player', {
                    height: '390',
                    width: '640',
                    videoId: video,
                    playerVars: {
                      'playsinline': 1
                    },
                    events: {
                      'onReady': onPlayerReady,
                      'onStateChange': onPlayerStateChange
                    }
                  });
                }
          
                // 4. The API will call this function when the video player is ready.
                function onPlayerReady(event) {
                  event.target.playVideo();
                  if (seek > 0){
                      event.target.seekTo(seek);
                  }
                }
          
                // 5. The API calls this function when the player's state changes.
                //    The function indicates that when playing a video (state=1),
                //    the player should play for six seconds and then stop.
                var done = false;
                function onPlayerStateChange(event) {
                  if (event.data == YT.PlayerState.PAUSED || event.data == YT.PlayerState.ENDED) {
                      //should use same for transcript function.  
                      midienabled = 0;
                  }
          
                  if (event.data == YT.PlayerState.PLAYING) {
          //          setTimeout(stopVideo, 6000);
          //			console.log("state change");
                      midienabled = 1;
                      
                    done = true;
                  }
                }
                function stopVideo() {
                  player.stopVideo();
                }
              </script>

</body>


</html>
